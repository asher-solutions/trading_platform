{% extends "base.html" %}
{% load static tailwind_tags %}

{% block title %}Model Editor{% endblock %}

{% block extra_css %}
{% tailwind_css %}
<style>
    .grid-bg {
        background-size: 20px 20px;
        background-image: linear-gradient(to right, #e5e5e5 1px, transparent 1px),
                          linear-gradient(to bottom, #e5e5e5 1px, transparent 1px);
    }
    .component-item {
        @apply p-2 bg-white border border-gray-300 rounded cursor-move mb-2 hover:bg-gray-50;
    }
    .sidebar-category {
        @apply mb-2 text-sm font-medium text-gray-700 cursor-pointer;
    }
    .toolbar-button {
        @apply p-1 rounded-full hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors;
    }
    .action-button {
        @apply px-4 py-2 rounded-md shadow-sm text-white font-medium;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 dark:bg-gray-900">
    <!-- Left Sidebar -->
    <div id="left-sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-md overflow-y-auto transition-all duration-300 ease-in-out">
        <div class="p-4">
            <button id="toggle-sidebar" class="w-full text-left mb-4">
                <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <select id="template-select" class="w-full mb-4 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="default">Default Template</option>
                <option value="advanced">Advanced Template</option>
                <option value="custom">Custom Template</option>
            </select>

            <div id="component-tree">
                <!-- Component categories will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Toolbar -->
        <div class="bg-gray-200 dark:bg-gray-800 p-2 flex justify-between items-center shadow-sm">
            <div class="flex space-x-2">
                <button id="undo" class="toolbar-button" title="Undo">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                </button>
                <button id="redo" class="toolbar-button" title="Redo">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"></path>
                    </svg>
                </button>
                <button id="zoom-in" class="toolbar-button" title="Zoom In">+</button>
                <button id="zoom-out" class="toolbar-button" title="Zoom Out">-</button>
                <button id="connect" class="toolbar-button bg-blue-500 text-white hover:bg-blue-600" title="Connect">Connect</button>
                <button id="clear" class="toolbar-button bg-red-500 text-white hover:bg-red-600" title="Clear">Clear</button>
            </div>
            <button id="fullscreen" class="toolbar-button" title="Toggle Fullscreen">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                </svg>
            </button>
        </div>

        <!-- Canvas -->
        <div id="canvas" class="flex-1 grid-bg p-4 overflow-auto">
            <!-- Components will be dropped here -->
        </div>

        <!-- Action Buttons -->
        <div class="bg-gray-200 dark:bg-gray-800 p-4 flex justify-center space-x-4 shadow-sm">
            <button id="compile" class="action-button bg-blue-500 hover:bg-blue-600">Compile</button>
            <button id="save-model" class="action-button bg-green-500 hover:bg-green-600">Save Model</button>
            <button id="backtest-model" class="action-button bg-purple-500 hover:bg-purple-600">Backtest Model</button>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div id="right-sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-md overflow-y-auto transition-all duration-300 ease-in-out">
        <div class="p-4">
            <h2 class="text-lg font-semibold mb-4">Your Models</h2>
            <div id="models-list">
                <!-- User models will be dynamically added here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Component tree data
    const componentTree = {
        'Enter Strategies': ['Strategy A', 'Strategy B'],
        'Exit Strategies': ['Strategy X', 'Strategy Y'],
        'Signal Models': ['Model 1', 'Model 2'],
        'Data Loader': ['Loader A', 'Loader B'],
        'Market Scanner': ['Scanner 1', 'Scanner 2'],
        'Environment Conditions': ['Condition A', 'Condition B'],
        'Custom': ['Custom 1', 'Custom 2'],
    };

    // Mock user models data
    const userModels = [
        {
            id: '1',
            name: 'Model A',
            versions: [
                { id: '1.1', version: 'v1.0', status: 'beta' },
                { id: '1.2', version: 'v1.1', status: 'alpha' },
            ],
        },
        {
            id: '2',
            name: 'Model B',
            versions: [
                { id: '2.1', version: 'v1.0', status: 'production' },
            ],
        },
    ];

    // Function to render component tree
    function renderComponentTree() {
        const treeContainer = document.getElementById('component-tree');
        treeContainer.innerHTML = '';

        for (const [category, components] of Object.entries(componentTree)) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'mb-4';
            categoryDiv.innerHTML = `
                <button class="sidebar-category flex items-center justify-between w-full text-left font-semibold text-gray-700 dark:text-gray-300">
                    ${category}
                    <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <ul class="ml-4 mt-2 space-y-2 hidden">
                    ${components.map(component => `
                        <li class="component-item" draggable="true" data-component="${component}" data-category="${category}">
                            ${component}
                        </li>
                    `).join('')}
                </ul>
            `;
            treeContainer.appendChild(categoryDiv);
        }

        // Add event listeners for category toggling and drag operations
        treeContainer.querySelectorAll('.sidebar-category').forEach(button => {
            button.addEventListener('click', () => {
                const list = button.nextElementSibling;
                list.classList.toggle('hidden');
                button.querySelector('svg').classList.toggle('rotate-180');
            });
        });

        treeContainer.querySelectorAll('.component-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', item.dataset.component);
                e.dataTransfer.setData('category', item.dataset.category);
            });
        });
    }

    // Function to render user models
    function renderUserModels() {
        const modelsContainer = document.getElementById('models-list');
        modelsContainer.innerHTML = '';

        userModels.forEach(model => {
            const modelDiv = document.createElement('div');
            modelDiv.className = 'mb-4';
            modelDiv.innerHTML = `
                <button class="flex items-center justify-between w-full text-left font-medium text-gray-700 dark:text-gray-300">
                    ${model.name}
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <ul class="ml-4 mt-2 space-y-2 hidden">
                    ${model.versions.map(version => `
                        <li class="flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded shadow">
                            <span>${version.version}</span>
                            <span class="px-2 py-1 text-xs font-semibold text-white rounded-full bg-${version.status === 'beta' ? 'yellow' : version.status === 'alpha' ? 'blue' : 'green'}-500">
                                ${version.status}
                            </span>
                        </li>
                    `).join('')}
                </ul>
            `;
            modelsContainer.appendChild(modelDiv);
        });

        // Add event listeners for model toggling
        modelsContainer.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', () => {
                const list = button.nextElementSibling;
                list.classList.toggle('hidden');
                button.querySelector('svg').classList.toggle('rotate-180');
            });
        });
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
        renderComponentTree();
        renderUserModels();

        // Canvas drag and drop operations
        const canvas = document.getElementById('canvas');
        canvas.addEventListener('dragover', (e) => e.preventDefault());
        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const component = e.dataTransfer.getData('text/plain');
            const category = e.dataTransfer.getData('category');
            const componentEl = document.createElement('div');
            componentEl.className = 'absolute bg-white dark:bg-gray-700 border p-2 rounded shadow cursor-move';
            componentEl.style.left = `${e.clientX}px`;
            componentEl.style.top = `${e.clientY}px`;
            componentEl.textContent = component;
            componentEl.dataset.category = category;
            canvas.appendChild(componentEl);
            // Make the component draggable within the canvas
            componentEl.draggable = true;
            componentEl.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', 'move');
                e.dataTransfer.setDragImage(componentEl, 0, 0);
            });
        });

        // Implement other functionalities (undo, redo, zoom, connect, clear, fullscreen, compile, save, backtest)
        // These will need to be implemented with proper logic and API calls
    });
</script>
{% endblock %}